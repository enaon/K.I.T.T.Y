<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>sCAT-a</title>
  <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:400,600" rel="stylesheet">
</head>

<body style="width:device-width;height:800px">

  <link href="tinydash.css" rel="stylesheet">
  <script src="tinydash.js"></script>


  <script src="https://www.puck-js.com/puck.js"></script>


  <script>
    var myDevice;
    var myService = 0xffa0; // fill in a service you're looking for here
    var myCharacteristic = 0xffa1; // fill in a characteristic from the service here
    var connection=[];
    function connect() {
      navigator.bluetooth.requestDevice({
          // you can't use filters and acceptAllDevices together
         filters: [ 
            //{ services: ['0000ffa0-0000-1000-8000-00805f9b34fb' ] },
            { namePrefix: 'eL-'},
          ] ,
          optionalServices: [myService],
          acceptAllDevices: false
        })
        .then(function(device) {
          myDevice = device;
          return device.gatt.connect();
        })
        .then(function(server) {
          console.log("connected",myDevice.id);
          return server.getPrimaryService(myService);
        })
        .then(function(service) {
          return service.getCharacteristics();
          //return service.getCharacteristic(myCharacteristic);
        })
        .then(function(characteristic) {
          console.log("characyeristic :",characteristic);
          for (c in characteristic) {
            console.log("got :",characteristic[c]);
              connection[c]=characteristic[c];
              characteristic[c].startNotifications()
              .then(subscribeToChanges);
          }
          /*characteristic.startNotifications()
              .then(subscribeToChanges);
          console.log("got :",characteristic);*/
          elements.modal.remove();
          //connection=characteristic[0];

        })
        .catch(function(error) {
          // catch any errors:
          console.error('Connection failed!', error);
        });
    }

    // subscribe to changes from the meter:
    function subscribeToChanges(characteristic) {
      console.log("sub :",characteristic);
      characteristic.oncharacteristicvaluechanged = handleData;
    }
    // handle incoming data:
    function handleData(event) {
      // get the data buffer from the meter:
      var buf = new Uint8Array(event.target.value);
      console.log("in :",event.target.value);
    }
    function write(v) {
      const encoder = new TextEncoder('utf-8');
      const data = encoder.encode(v);
      connection[7].writeValue(data).then(function() {
    	//connection.writeValue(new Uint16Array([0x0120030000000000])).then(function() {
      console.log("send :"+data);
			}).catch(function(error)  {
        console.error('send failed!', error);
			});
    }

    var sandType = { 1: "betonite", 2: "silicone", 3: "nonstick", 4: "tofu" };
    var pos = -1;
    var busy = -1;
    var refresh = { uv: -1, bs: -1, ps: -1, db: -1, ac: -1, ad: -1, pb: -1, pos: -1, pbv: -1, sp: -1, ss: -1, pwr: -1 };

    function onLine(line) {
      try {
        var j = JSON.parse(line);
        //console.log("Received JSON: ",j);
        //busy-today-pause
        if (j.bs) {
          if (!busy) {
            busy = 1;
            elements.st.setValue("BUSY");
            elements.rtod.replaceWith(elements.ps);
          }
          if (j.ps != refresh.ps) { refresh.ps = j.ps;
            elements.ps.setValue(j.ps); }
        }
        else if (!j.bs) {
          if (busy) {
            busy = 0;
            elements.st.setValue(120 < j.pb ? "ON" : "IDLE");
            elements.ps.replaceWith(elements.rtod);
          }
          if (j.rtod != refresh.rtod) { refresh.rtod = j.rtod;
            elements.rtod.setValue(j.rtod); }
        }
        //litres
        if (j.lit != refresh.lit) { refresh.lit = j.lit;
          elements.lit.setValue(j.lit); }
        //powerbank voltage
        if (j.pbv != refresh.pbv) { refresh.pbv = j.pbv;
          elements.pbv.setValue(j.pbv + " V"); }
        //elements.cbv.setValue(j.cbv); //controler voltage
        //auto clean / delay
        if (j.ac != refresh.ac) { refresh.ac = j.ac;
          elements.ac.setValue(j.ac); }
        if (j.ad != refresh.ad) { refresh.ad = j.ad;
          elements.ad.setValue(j.ad); }
        // name
        if (j.sp != refresh.sp) {
          refresh.sp = j.sp;
          elements.sp.setValue(j.sp);
          elements.pn.setValue(sandType[j.sp]);

        }
        //uvc
        if (j.uv != refresh.uv) { refresh.uv = j.uv;
          elements.uv.setValue(j.uv); }
        //speed
        if (j.ss != refresh.ss) { refresh.ss = j.ss;
          elements.ss.setValue(j.ss); }
        //debug
        if (j.db != refresh.db) {
          refresh.db = j.db;
          elements.db.setValue(j.db);
          if (j.db) {
            elements.log1.replaceWith(elements.log);
          }
          else
            elements.log.replaceWith(elements.log1);
        }
        // status
        //if (j.pwr!=refresh.pwr) { refresh.pwr=j.pwr; elements.pwr.setValue(j.pwr);} 
        //powerbank persentage / position
        if (120 < j.pb && !pos) {
          pos = 1;
          elements.pb.replaceWith(elements.pos);
        }
        else if (j.pb < 120 && pos) {
          pos = 0;
          elements.pos.replaceWith(elements.pb);
        }
        if (!pos) {
          if (j.pb != refresh.pb) { refresh.pb = j.pb;
            elements.pb.setValue(100 < j.pb ? 100 : j.pb); } //percentage
        }
        else
        if (j.pos != refresh.pos) { refresh.pos = j.pos;
          elements.pos.setValue(j.pos * 100 | 0); } //position
        //debug console
      }
      catch (e) {
        console.log("Received: ", line);
        elements.log.log(line);
      }
    }
    //JSON.stringify({uv:scata.state.def.auto.uvc,ps:scata.state.is.sys.pause,bs:scata.state.is.sys.busy,db:scata.state.def.is.dbg,ac:scata.state.def.auto.clean,ad:scata.state.def.auto.delay,rtod:scata.state.is.sys.run,pos:scata.state.is.pos.ball,pwr:scata.state.is.sys.pwr,lit:scata.state.is.volt.litres,pbv:ew.is.ondcVoltage(),ss:scata.state.def.sandType[scata.state.def.is.sand].speed,sp:scata.state.def.is.sand,cb:ew.is.batt(1),pb:ew.is.ondcVoltage(1)}));},100);NRF.on('disconnect', function() {clearInterval(lala);scata.action.sleep()});\n",

    // Set up the controls we see on the screen
    var data = [];
    for (var i = 0; i < 100; i++) data.push(Math.cos(i / 10));
    var elements = {
      heading: TD.label({ x: 10, y: 10, width: 300, height: 50, label: " sCAT-a" }),
      st: TD.value({ x: 310, y: 10, width: 100, height: 50, label: "", value: "0" }),
      pos: TD.gauge({ x: 10, y: 70, width: 220, height: 220, label: "BALL POSITION", value: 0, min: 0, max: 200 }),
      pb: TD.gauge({ x: 10, y: 70, width: 220, height: 220, label: "BATTERY PERCENTAGE", value: 0, min: 0, max: 100 }),
      ps: TD.toggle({ x: 230, y: 70, width: 180, height: 55, label: "PAUSE", value: "0", onchange: function(el, v) { write("scata.state.is.sys.pause=" + v + ";\n"); } }),

      rtod: TD.value({ x: 230, y: 70, width: 180, height: 55, label: "TODAY", value: "2" }),
      rtot: TD.value({ x: 230, y: 125, width: 180, height: 55, label: "TOTAL", value: "13" }),
      lit: TD.value({ x: 230, y: 180, width: 180, height: 55, label: "LITRES", value: "0" }),
      pbv: TD.value({ x: 230, y: 235, width: 180, height: 55, label: "VOLT", value: "0" }),
      //cb : TD.gauge({x:210,y:70,width:200,height:220,label:"Controller Battery",value:0,min:0,max:100}),
      /*pwr:   TD.toggle({x:10,y:300,width:400,height:60,label:"Auto Empty",value:0,name:"Toggle",onchange:function(el,v) { 
        if (v)  
          write("scata.call.wake();\n");
        else 
          write("scata.action.sleep();\n");
      }}),
      */
      //manual clean
      cl: TD.button({
        x: 10,
        y: 300,
        width: 200,
        height: 120,
        label: "CLEAN SAND",
        value: 0,
        name: "button",
        onchange: function(el, v) {
          if (v)
            write("ew.emit('button','long');\n");
        }
      }),
      //manual empty
      em: TD.button({
        x: 210,
        y: 300,
        width: 200,
        height: 120,
        label: "EMPTY SAND",
        value: 0,
        name: "button",
        onchange: function(el, v) {
          if (v)
            write("ew.emit('button','triple');\n");
        }
      }),
      //onchange:function(el,v) { write("scata.state.is.sys.pause="+v+";\n");}}),
      //auto clean/delay time/uvc
      ac: TD.toggle({ x: 10, y: 480, width: 195, height: 70, label: "AUTO", value: "0", name: "Toggle", onchange: function(el, v) { write("scata.state.acc(" + v + ");\n"); } }),
      ad: TD.value({ x: 10, y: 550, width: 195, height: 70, label: "DELAY", value: "1", min: 1, step: 1, max: 10, onchange: function(el, v) { write("scata.state.def.auto.delay=" + v + ";\n"); } }),
      uv: TD.toggle({ x: 10, y: 620, width: 195, height: 80, id: 5, label: "UVC", value: "0", name: "Toggle", onchange: function(el, v) { write("scata.state.def.auto.uvc=" + v + ";\n"); } }),
      //ball patern/speed
      pn: TD.value({ x: 215, y: 540, width: 195, height: 80, label: "", value: "0" }),
      sp: TD.value({ x: 215, y: 480, width: 195, height: 80, label: "MODE", value: "1", min: 1, step: 1, max: 3, onchange: function(el, v) { write("scata.state.def.is.sand=" + v + ";\n"); } }),
      ss: TD.value({ x: 215, y: 620, width: 195, height: 80, label: "SPEED", value: "1", min: 0.5, step: 0.1, max: 1.5, onchange: function(el, v) { write("scata.state.def.sandType[scata.state.def.is.sand].speed=" + v + ";\n"); } }),
      //debug
      db: TD.toggle({ x: 10, y: 710, width: 195, height: 65, label: "DBG", value: "0", name: "Toggle", onchange: function(el, v) { write("scata.state.def.is.dbg=" + v + ";\n"); } }),
      //save settings
      sv: TD.button({ x: 215, y: 710, width: 195, height: 65, label: "SAVE", value: 0, name: "", onchange: function() { elements.log.log("SETTINGS SAVED");
          write("scata.state.update();\n"); } }),
      //log
      log: TD.log({ x: 10, y: 785, width: 400, height: 400, id: 5, label: "Console output", text: "Scat-A" }),
      log1: TD.label({ x: 1, y: 1, width: 1, height: 1, label: "" }),
      //modal: TD.modal({x:10,y:10,width:400,height:270,label:"Click to connect",onchange:connectDevice})
      modal: TD.modal({ x: 10, y: 10, width: 400, height: 270, label: "Click to connect", onchange: connect })


      //gr:TD.graph({x:10,y:400,width:400,height:170,label:"A Graph",data:data}),
    }
    elements.log.log("Version 1.0");
    for (var i in elements)
      document.body.appendChild(elements[i]);
    //TD.startEditor();
  </script>
</body>

</html>
