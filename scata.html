<html>
 <head>
  <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>sCAT-a</title>
    <link href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:400,600" rel="stylesheet">
 </head>
  <body style="width:device-width;height:800px">
  <link href="tinydash.css" rel="stylesheet">
  <script src="tinydash.js"></script>
  <script src="https://www.puck-js.com/puck.js"></script>
  <script>
  //<body style="width:420px;height:800px">
  //<meta name="viewport" content="width=420, initial-scale=1">
  // Called when we get a line of data - updates the light color
  var sandType={1:"betonite",2:"silicone",3:"nonstick",4:"tofu"};
  var pos=0;var busy=1;
  var refresh={uv:-1,bs:-1,ps:-1,db:-1,ac:-1,ad:-1,pb:-1,pos:-1,cb:-1,pbv:-1,sp:-1,ss:-1,pwr:-1};
  function onLine(line) {
    try {
      var j = JSON.parse(line);
      //console.log("Received JSON: ",j);
      //busy-today-pause
      if ( j.bs!=refresh.bs){
        refresh.bs=j.bs;
        if ( j.bs) {
          //if (busy==0){ busy=1; 
            elements.st.setValue("BUSY");
            elements.he.replaceWith(elements.ps);
            elements.clean.replaceWith(elements.abort);
         // }
          if (j.ps!=refresh.ps) { refresh.ps=j.ps; elements.ps.setValue(j.ps);}
        }else{
          //if (busy){ busy=0;  
            elements.st.setValue(120<j.pb?"ON":"IDLE");
            elements.ps.replaceWith(elements.he);
            elements.abort.replaceWith(elements.clean);
  
          //}
          //if (j.rtod!=refresh.rtod) { refresh.rtod=j.rtod; elements.rtod.setValue(j.rtod);}
        }
      }
      //today
      if (j.rtod!=refresh.rtod) { refresh.rtod=j.rtod; elements.rtod.setValue(j.rtod);}
      //litres
      if (j.lit!=refresh.lit) { refresh.lit=j.lit; elements.lit.setValue(j.lit);}
      //powerbank voltage
      if (j.pbv!=refresh.pbv) { refresh.pbv=j.pbv; elements.pbv.setValue(j.pbv.toFixed(2)+" V");}
      //CONTROLER VOLTAGE
      if (j.cbv!=refresh.cb) { refresh.cb=j.cb; elements.cb.setValue(j.cb.toFixed(2)+" V");}
      //auto clean / delay
      if (j.ac!=refresh.ac) { refresh.ac=j.ac; elements.ac.setValue(j.ac);} 
      if (j.ad!=refresh.ad) { refresh.ad=j.ad; elements.ad.setValue(j.ad);}
      // name
      if (j.sp!=refresh.sp) { 
        refresh.sp=j.sp; elements.sp.setValue(j.sp);
        elements.pn.setValue(sandType[j.sp]);
        
      } 
      //uvc
      if (j.uv!=refresh.uv) { refresh.uv=j.uv; elements.uv.setValue(j.uv);}
      //speed
      if (j.ss!=refresh.ss) { refresh.ss=j.ss; elements.ss.setValue(17-(j.ss*10));}
      //debug
      if (j.db!=refresh.db) { 
        refresh.db=j.db; elements.db.setValue(j.db);
        if (j.db ) {
          elements.logBlank.replaceWith(elements.log); 
         } else
          elements.log.replaceWith(elements.logBlank);
      } 
      // status
      if (j.pwr!=refresh.pwr) { refresh.pwr=j.pwr; elements.pwr.setValue(j.pwr);} 
      //powerbank persentage / position
      if ( 120<j.pb && !pos) {
        pos=1;
        elements.pb.replaceWith(elements.pos);
      } else if ( j.pb <120&& pos) {
        pos=0;
        elements.pos.replaceWith(elements.pb);
      }
      if (!pos) {
        if (j.pb!=refresh.pb) { refresh.pb=j.pb; elements.pb.setValue(100<j.pb?100:j.pb);} //percentage
      }else  
          if (j.pos!=refresh.pos) { refresh.pos=j.pos; elements.pos.setValue(j.pos*100|0);} //position
    //debug console
    } catch(e) {
      console.log("Received: ",line);
      if (line.startsWith("log-") ) elements.log.log(line);
    }
  }
  var connection={};
  connection.write=function(){elements.log.log("Not Connected yet");}  
  function connectDevice() {
    Puck.connect(function(c) {
      if (!c) {
        alert("Couldn't connect!");
        return;
      }
      connection = c;
      // remove modal window
      elements.modal.remove();
      // Handle the data we get back, and call 'onLine'
      // whenever we get a line
      var buf = "";
      connection.on("data", function(d) {
        buf += d;
        var i = buf.indexOf("\n");
        while (i>=0) {
          onLine(buf.substr(0,i));
          buf = buf.substr(i+1);
          i = buf.indexOf("\n");
        }
      });
      connection.write("lala=setInterval(function(){Bluetooth.println(JSON.stringify({uv:scata.state.def.auto.uvc,ps:scata.state.is.sys.pause,bs:scata.state.is.sys.busy,db:scata.state.def.is.dbg,ac:scata.state.def.auto.clean,ad:scata.state.def.auto.delay,rtod:scata.state.is.sys.run,pos:scata.state.is.pos.ball,pwr:scata.state.is.sys.pwr,lit:scata.state.is.volt.litres,pbv:ew.is.ondcVoltage(),ss:scata.state.def.sandType[scata.state.def.is.sand].speed,sp:scata.state.def.is.sand,cb:ew.is.batt(),pb:ew.is.ondcVoltage(1)}));},100);NRF.on('disconnect', function() {clearInterval(lala);scata.action.sleep()});\n",
        function() { console.log("Ready..."); });
    });
  }
  // Set up the controls we see on the screen
   var data = [];
     for (var i=0;i<100;i++) data.push(Math.cos(i/10));
  var elements = {
    //header
    heading : TD.label({x:0,y:10,width:400,height:60,label:" sCAT-a"}),
    //right dash
    pos : TD.gauge({x:0,y:70,width:230,height:220,label:"BALL POSITION",value:0,min:0,max:205}),
    pb : TD.gauge({x:0,y:70,width:230,height:220,label:"BATTERY PERCENTAGE",value:0,min:0,max:100}),
    ps: TD.toggle({x:0,y:290,width:230,height:60,label:"PAUSE",value:"0",onchange:function(el,v) { connection.write("scata.state.is.sys.pause="+v+";\n");}}),
    he:   TD.label({x:0,y:290,width:230,height:60,label:""}),
    //left dash
    rtod: TD.value({x:230,y:50,width:170,height:55,label:"TODAY",value:"2"}),
    rtot: TD.value({x:230,y:105,width:170,height:55,label:"TOTAL",value:"13"}),
    lit: TD.value({x:230,y:160,width:170,height:55,label:"LITRES",value:"0"}),
    pbv: TD.value({x:230,y:215,width:170,height:60,label:"VOLT",value:"0"}),
    //controller
    cb:   TD.value({x:230,y:270,width:170,height:80,label:"DSD6",value:0}),
    //
    //lcd 
    hb:   TD.label({x:0,y:360,width:400,height:70,label:""}),
    st: TD.value({x:100,y:360,width:200,height:60,label:"",value:"0"}),
    //
    //midle
    //
    heading_more1 : TD.label({x:0,y:440,width:195,height:260,label:""}),
    heading_more2 : TD.label({x:205,y:440,width:195,height:260,label:""}),
    //manual clean
    abort:   TD.button({x:0,y:480,width:195,height:90,color:555,label:"",value:0,name:"button",glyph:"ABORT",onchange:function(el,v) { 
      if (v)  {
        connection.write("scata.state.is.sys.abort=1;\n");
      }

    }}), 
    clean:   TD.button({x:0,y:480,width:195,height:90,color:555,label:"",value:0,name:"button",glyph:"CLEAN",onchange:function(el,v) { 
      if (v)  {
        connection.write("ew.emit('button','long');\n");
      }
      else{
      }
    }}),   
    //manual empty
    em:   TD.button({x:205,y:480,width:195,height:70,label:"",value:0,name:"button",glyph:"EMPTY",onchange:function(el,v) { 
      if (v)  
        connection.write("ew.emit('button','triple');\n");
    }}),
    //
    //
    //settings
    //auto clean on-off
    ac:TD.toggle({x:0,y:460,width:195,height:80,label:"AUTO",value:0,name:"Toggle",onchange:function(el,v) { connection.write("scata.state.acc("+v+");\n");}}),
    //auto clean delay
    ad:TD.value({x:0,y:540,width:195,height:80,label:"DELAY",value:"1",min:1,step:1,max:0, onchange:function(el,v) { connection.write("scata.state.def.auto.delay="+v+";\n");}}),
    //uvc light trigger
    uv:TD.toggle({x:0,y:620,width:195,height:80,id:5,label:"UVC",value:0,name:"Toggle",onchange:function(el,v) { connection.write("scata.state.def.auto.uvc="+v+";\n");}}),
    //patern mode 
    sp:TD.value({x:205,y:460,width:195,height:80,label:"MODE",value:"1",min:1,step:1,max:3,onchange:function(el,v) { connection.write("scata.state.def.is.sand="+v+";\n");}}),
    //patern name
    pn: TD.value({x:205,y:540,width:195,height:80,label:"",value:"0"}),
    //patern speed
    ss:TD.value({x:205,y:620,width:195,height:80,label:"SPEED",value:5,min:1,step:1,max:9, onchange:function(el,v) { connection.write("scata.state.def.sandType[scata.state.def.is.sand].speed="+(17-v)/10+";\n");}}),
    //
    //
    //more
    more1:   TD.label({x:0,y:0,width:0,height:0,label:""}),
    more2:   TD.label({x:0,y:0,width:0,height:0,label:""}),
    more3:   TD.label({x:0,y:0,width:0,height:0,label:""}),
    more4:   TD.label({x:0,y:0,width:0,height:0,label:""}),
    //on-off
    pwr:   TD.toggle({x:0,y:580,width:195,height:70,label:"LIGHT",value:0,name:"button",onchange:function(el,v) { 
        
        connection.write("ew.emit('button','short');\n");

    }}),
    time:   TD.button({x:205,y:580,width:195,height:70,label:"",value:0,name:"button",glyph:"TIME",onchange:function(el,v) { 
      if (v) {
      let d = new Date();
      let tz = d.getTimezoneOffset()/-60
      let cmd = 'setTime('+(d.getTime()/1000)+');';
      cmd += 'E.setTimeZone('+tz+');';
      //cmd += "(s=>{s&&(s.timezone="+tz+")&&require('Storage').write('ew.json',s);})(require('Storage').readJSON('ew.json',1))\n";
      connection.write(cmd);
      elements.log.log("Time Set");
      }
    }}),

    //    
    //
    //footer
    //set
    settings:TD.toggle({x:0,y:710,width:195,height:75,label:"SET",value:0,name:"Toggle",onchange:function(el,v) { 
        if (v==1){
            elements.pwr.replaceWith(elements.ac); 
            elements.em.replaceWith(elements.ad); 
            elements.time.replaceWith(elements.uv); 
            elements.more2.replaceWith(elements.sp); 
            elements.more3.replaceWith(elements.pn); 
            elements.more4.replaceWith(elements.ss); 
        } else {
            elements.log.log("Settings Saved");
            connection.write("scata.state.update();\n");
            elements.ac.replaceWith(elements.pwr); 
            elements.ad.replaceWith(elements.em); 
            elements.uv.replaceWith(elements.time); 
            elements.sp.replaceWith(elements.more2); 
            elements.pn.replaceWith(elements.more3); 
            elements.ss.replaceWith(elements.more4); 
        }
    }}),
    //debug
    db:TD.toggle({x:205,y:710,width:195,height:75,label:"DBG",value:0,name:"Toggle",onchange:function(el,v) { 
        connection.write("scata.state.def.is.dbg="+v+";\n");
        if (v){
            elements.logBlank.replaceWith(elements.log); 
        } else
            elements.log.replaceWith(elements.logBlank);
        
      }}),
    //save settings
    //sv:TD.button({x:205,y:710,width:195,height:75,label:"SAVE",value:0,name:"",onchange:function() { elements.log.log("SETTINGS SAVED");connection.write("scata.state.update();\n");}}),
    //log
    log:TD.log({x:0,y:800,width:400,height:400,id:5,label:"Console output",text:"Scat-A"}),
    logBlank:TD.label({x:1,y:1,width:1,height:1,label:""}),
    modal: TD.modal({x:0,y:10,width:395,height:460,label:"Click to connect",onchange:connectDevice})
    
  }
  elements.log.log("Version 1.0");
  for (var i in elements)
    document.body.appendChild(elements[i]);
    elements.log.replaceWith(elements.logBlank);
    elements.ac.replaceWith(elements.pwr); 
    elements.ad.replaceWith(elements.em); 
    elements.uv.replaceWith(elements.more1); 
    elements.sp.replaceWith(elements.more2); 
    elements.pn.replaceWith(elements.more3); 
    elements.ss.replaceWith(elements.more4);

    //TD.startEditor();
  </script>
 </body>
</html>


